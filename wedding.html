<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Viewer</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: white; }
    .tab-bar {
      display: flex;
      justify-content: center;
      background-color: #f1f1f1;
      border-bottom: 2px solid #ccc;
    }
    .tab {
      flex: 1;
      padding: 1em;
      text-align: center;
      cursor: pointer;
      font-size: 1.2em;
      background-color: #f1f1f1;
      border: none;
      outline: none;
    }
    .tab.active {
      background-color: #bb819b; /* English Lavender-ish */
      color: white;
      font-weight: bold;
    }
    .container {
      padding: 2em;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.75em;
      margin-bottom: 1em;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 0.75em;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #bb819b /* English Lavender-ish */;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="tab-bar">
    <button class="tab" id="photoTab">Photo Groups</button>
    <button class="tab" id="seatingTab">Seating Chart</button>
  </div>
  <div class="container">
    <input type="text" id="searchInput" placeholder="Search your name..." onkeyup="filterTable()" />
    <table id="dataTable">
      <thead>
        <tr>
          <th onclick="toggleSortByName()">Name &#x25B2;&#x25BC;</th>
          <th onclick="toggleSortByGroup()">Group/Table &#x25B2;&#x25BC;</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    const photoUrl = 'photo_groups_wide.csv';
    const seatingUrl = 'seating_chart_wide.csv';
    const photoTab = document.getElementById('photoTab');
    const seatingTab = document.getElementById('seatingTab');
    const now = new Date();
    const utcHour = now.getUTCHours();
    const isAfter4pmEST = utcHour >= 20; // 4 PM EST = 20 UTC
    let currentCSV = isAfter4pmEST ? seatingUrl : photoUrl;
    let currentData = [];
    let nameSortAsc = true;
    let groupSortAsc = true;

    function setActive(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    async function fetchCSV(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network error");
        const text = await response.text();
        const rows = text.trim().split('\n').map(r => r.split(','));
        const headers = rows[0];
        const tableBody = document.querySelector('#dataTable tbody');
        tableBody.innerHTML = '';
        currentData = [];

        for (let i = 1; i < rows.length; i++) {
          for (let j = 0; j < headers.length; j++) {
            const name = rows[i][j]?.trim();
            if (name) {
              currentData.push({ name, group: headers[j] });
            }
          }
        }
        sortByName(true); // force default ascending name sort
      } catch (e) {
        console.error("Failed to load CSV:", e);
      }
    }

    function renderTable(data) {
      const tableBody = document.querySelector('#dataTable tbody');
      tableBody.innerHTML = '';
      data.forEach(entry => {
        const groupLabel = (currentCSV === photoUrl) ? `Photogroup ${entry.group.match(/\d+/)?.[0] || entry.group}` : entry.group;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${entry.name}</td><td>${groupLabel}</td>`;
        tableBody.appendChild(tr);
      });
    }

    function stripPrefix(name) {
      return name.replace(/^Dr\.?\s*/i, '').trim();
    }

    function sortByName(forceAsc = false) {
      currentData.sort((a, b) => {
        const nameA = stripPrefix(a.name).toLowerCase();
        const nameB = stripPrefix(b.name).toLowerCase();
        return (nameSortAsc || forceAsc) ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
      });
      renderTable(currentData);
    }

    function toggleSortByName() {
      nameSortAsc = !nameSortAsc;
      sortByName();
    }

    function sortByGroup() {
      currentData.sort((a, b) => {
        const groupA = parseInt(a.group.match(/\d+/));
        const groupB = parseInt(b.group.match(/\d+/));
        return groupSortAsc ? groupA - groupB : groupB - groupA;
      });
      renderTable(currentData);
    }

    function toggleSortByGroup() {
      groupSortAsc = !groupSortAsc;
      sortByGroup();
    }

    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#dataTable tbody tr");
      rows.forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        row.style.display = name.includes(input) ? "" : "none";
      });
    }

    photoTab.addEventListener('click', () => {
      currentCSV = photoUrl;
      setActive('photoTab');
      fetchCSV(currentCSV);
    });
    seatingTab.addEventListener('click', () => {
      currentCSV = seatingUrl;
      setActive('seatingTab');
      fetchCSV(currentCSV);
    });

    window.onload = () => {
      setActive(isAfter4pmEST ? 'seatingTab' : 'photoTab');
      fetchCSV(currentCSV);
    }
  </script>
</body>
</html>
